<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Survey + Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: sans-serif; }
    #tripettoFrame { width: 100%; height: 100%; border: 0; }
    #mapOverlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      display: none; align-items: center; justify-content: center;
      z-index: 10;
    }
    #mapBox {
      background: white; width: 90%; height: 80%;
      border-radius: 10px; overflow: hidden; position: relative;
    }
    #map { width: 100%; height: 100%; }
    #closeMap {
      position: absolute; top: 10px; right: 10px;
      background: #fff; border: 1px solid #ccc;
      padding: 4px 10px; border-radius: 6px; cursor: pointer;
    }
  </style>
</head>
<body>
  <iframe id="tripettoFrame" src="https://tripetto.app/run/5K4PTLSPST"></iframe>

  <div id="mapOverlay">
    <div id="mapBox">
      <button id="closeMap">× Close</button>
      <div id="map"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const tripettoBase = "https://tripetto.app/run/5K4PTLSPST";
    const iframe = document.getElementById('tripettoFrame');
    const mapOverlay = document.getElementById('mapOverlay');
    const closeMap = document.getElementById('closeMap');

    // --- Detect ?openmap=true ---
    const params = new URLSearchParams(window.location.search);
    if (params.get("openmap") === "true") {
      openMap();
      // remove query param so refresh won't reopen map
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    function openMap() {
      mapOverlay.style.display = 'flex';
    }
    closeMap.onclick = () => mapOverlay.style.display = 'none';

    const map = L.map('map').setView([35.9,14.5],9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let marker;
    map.on('click', e => {
      if (marker) map.removeLayer(marker);
      marker = L.marker(e.latlng).addTo(map);
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      if (confirm(`Use this location?\n${lat}, ${lng}`)) {
        iframe.src = `${tripettoBase}?lat=${lat}&lng=${lng}`;
        mapOverlay.style.display = 'none';
      }
    });
  </script>
</body>
</html>
